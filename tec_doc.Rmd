---
title: "Technical Document vs 0.1"
author: "Jan van Rongen"
date: "2021-10-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

We analyse data from the state Israel related to COVID vaccines and infections. This is the technical document that contains all code used.

The document itself is an RMarkdown worksheet that, when formatted in pdf, hides the code.

## Data sources and cleaning

We use four data sources: three from the Israeli government site and one from a spreadsheet with population data. The data was imported manually on 2021-10-02.

```{r echo= FALSE, message=FALSE, warning=FALSE}

source("get_clean.R") # get and clean data
source("./lib/lib.R") # plot routine
```

The file `vaccinated-per-day-2021-09-28` is aggregated to a per week file. Numeric fields with `<5` or `<15` were converted to 3 and 8 resp. Weeks are identified by their first day. Four missing records for the 90+ age category were added to `cases-among-vaccinated-134.csv`

Using the `population` table we construct cumulative totals of fulle vaccinated, single vaccinated and not vaccinated.

One file not yet used.

## Definitions and methods

_Fully vaccinated_ are people from the day of their second dose. _Single vaccinated_ are people that had one dose but not two (from the date of first dose). All others are _unvaccinated_. _Infected_ are people that (on a certain day) tested positive. All others are _not infected_ on that day.

A _cross table_ is a 2x2 table with two (0,1) categories. The entries are the number of people in that combination of categories. When the matrix is `|a b | c d|` then the _ralative risk_ AKA _risk ratio_ AKA _RR_ is (a/(a+b))/(c/(c+d)). The _odds ratio_ is also known as _OR_ is a.d/b.c

In epidemiologie RR and OR are used a lot. Numbers can be quite large, so in programming we have to avoid numerical overflow or incorrect rounding. 

## Data quality

Coding small numbers as `<5` or `<15` is a bit strange, but let's skip that. The population data has a bit of a problem. The table has `r sum(population$size)` for the total population, while wikipedia has 9364000, for 2019.  That means we will underestimate the number of unvaccinated people by (absolutely) 1 percentpoint. 

One more serious problem is the way the Israeli population is defined. All 450K+ colonists in the occupied part are counted, but not the Palestines that live there. Colonists have access to vaccines, Palestines not. That means that we actually work with incomplete data (or overcomplete, depending on your point of view).

Finally, I do not know if the most recent data is complete or whether there is some left in the pipeline. That can be done by caomparing with an older version of the files, but that is for later.

## Data overview

Note that one table has 40 weeks, one has 41.

First we aggregate over the 20+ age groups. 

### Fully vs non vaccinated Adults

In the last week in this sample, 83% of the Adults is fully vaccinated.


```{r echo=FALSE, fig.height=3, fig.width=5}
load("./data/vacc.Rdata")

fully_vac$Adults <- rowSums(fully_vac[,-(1:2)])
single_vac$Adults <- rowSums(single_vac[,-(1:2)])
not_vac$Adults <- rowSums(not_vac[,-(1:2)])


df<- make_cases(fully_vac[, c("weekstart", "Adults")])
df$cases<- df$cases/sum(population$size[-1])
pretty_date(df, ylab= "gedeelte", lwd=2, 
            ylim=c(0,1), 
            main="Israel adults\nFully vaccinated (red) vs non vaccinated (blue)")
df<- make_cases(not_vac[, c("weekstart", "Adults")])
df$cases<- df$cases/sum(population$size[-1])
pretty_date(add=T, kleur=2, lwd=2, df) 

```

### Same for youth

Youth (age group 0-19) has a low percentage fully vaccinated. 75% is not (yet)  vaccinated at all.


```{r echo=FALSE, fig.height=3, fig.width=5}


df<- make_cases(fully_vac[, c("weekstart", "0-19")])
df$cases<- df$cases/population$size[1]
pretty_date(df, ylab= "gedeelte", lwd=2, 
            ylim=c(0,1), 
            main="Israel Youth\nFully vaccinated (red) vs non vaccinated (blue)")
df<- make_cases(not_vac[, c("weekstart", "0-19")])
df$cases<- df$cases/population$size[1]
pretty_date(add=T, kleur=2, lwd=2, df) 

```

### Interesting second wave

```{r echo=FALSE, fig.height=3, fig.width=5}



# fully vaccinated after 0+ days 
# with 2nd dose or 3rd dose (aasuming they are exclusive)
# and without vaccins. 

age_group<- unique(df1$Age_group)
weekstart<- unique(df1$weekstart) # one less than previous files

full_vac_pos<- data.frame(weekstart=weekstart)
not_vac_pos<- data.frame(weekstart=weekstart)

# 
for( a in age_group){
  tmp<- rowSums(df1[df1$Age_group == a, c(7:14)])
  full_vac_pos<- cbind(full_vac_pos, tmp)
  tmp<- df1[df1$Age_group == a, 15]
  not_vac_pos <- cbind(not_vac_pos, tmp)
}

names(full_vac_pos)[-1]<- age_group
names(not_vac_pos)[-1]<- age_group

full_vac_pos$Adults <- rowSums(full_vac_pos[,-(1:2)])
not_vac_pos$Adults <- rowSums(not_vac_pos[,-(1:2)])

df<- make_cases(full_vac_pos[, c("weekstart", "Adults")])
df$cases<- df$cases
pretty_date(df, 
            lwd=2, ylim=c(0, 30000),
             main="Israel infected adults\nFully vaccinated(red) vs non vaccinated (blue)")
df<- make_cases(not_vac_pos[, c("weekstart", "Adults")])
df$cases<- df$cases
pretty_date(add=T, kleur=2, lwd=2, df) 


```

There are two remakable things here: almost no infections from april to end june and a high wave of infections later.

That begs the question: what is the RR? Did vaccination help? For the april-june period the numbers are probably too low for any accurate estimate, but for that second wave?

### Relative Risk for Adults

```{r  echo=FALSE, fig.height=3, fig.width=5}
# now to the Relative Risk. Or Risk Ratio. 
# for evry week we make a 2 by 2 table of fully/non vacc
# versus testes pos or negative. We have the marginals
# f1= full_vacc_pos
# f3 =not_vac_pos
# f2= full_vac -f1
# f4= not_vac-f2

risk<- data.frame(weekstart=weekstart)
risk$f1<- full_vac_pos$Adults
risk$f2<- fully_vac$Adults[1:40]- risk$f1
risk$f3<- not_vac_pos$Adults
risk$f4<- not_vac$Adults[1:40]- risk$f3
risk$m1<- risk$f1 + risk$f2
risk$m3<- risk$f3 + risk$f4

risk<- risk[-(1:3),] # remove non data
risk$f1<- risk$f1/risk$m1
risk$f2<- risk$f2/risk$m1
risk$f3<- risk$f3/risk$m3
risk$f4<- risk$f4/risk$m3

risk$RR<- risk$f1/risk$f3
risk$OR<- with(risk,f1*f4/(f2*f3))

df<- make_cases(risk[, c("weekstart", "RR")])
pretty_date(df, main="Relative risk for fully vaccinated adults in Israel")

```

That means that the relative risk for fully vaccinated adults in the week starting 2021-09-19 is 23% in other words not vaccinated people are at least 4 times more likely to get infected.

### Without the third shot

Maybe the decrease is caused by the start of "boosting": using a third shot. We repeat the above plot with data from people that had no third one,

```{r echo=FALSE, fig.height=3, fig.width=5}
dub_vac_pos<- data.frame(weekstart=weekstart)
# 
for( a in age_group){
  tmp<- rowSums(df1[df1$Age_group == a, c(7:10)])
  dub_vac_pos<- cbind(dub_vac_pos, tmp)
}

dub_vac_pos$Adults <- rowSums(dub_vac_pos[,-(1:2)])
triple_vac$Adults<- rowSums(triple_vac[,-(1:2)])
# f1= dub_vac_pos
# f3 =not_vac_pos
# f2= dub_vac -f1
# f4= not_vac-f2

risk<- data.frame(weekstart=weekstart)
risk$f1<- full_vac_pos$Adults
risk$f2<- fully_vac$Adults[1:40]- risk$f1- triple_vac$Adults[1:40]
risk$f3<- not_vac_pos$Adults
risk$f4<- not_vac$Adults[1:40]- risk$f3
risk$m1<- risk$f1 + risk$f2
risk$m3<- risk$f3 + risk$f4

risk<- risk[-(1:3),] # remove non data
risk$f1<- risk$f1/risk$m1
risk$f2<- risk$f2/risk$m1
risk$f3<- risk$f3/risk$m3
risk$f4<- risk$f4/risk$m3

risk$RR<- risk$f1/risk$f3
risk$OR<- with(risk,f1*f4/(f2*f3))

df<- make_cases(risk[, c("weekstart", "RR")])
pretty_date(df, main="Relative risk for fully without booster \nvaccinated adults in Israel")


```


## Conclusion

With the above overall data, it does not make much sense to look at the behaviour of smaller (age) groups. The above shows that for the whole adult population the VE=(1-RR) definetely does not approach  0. 
