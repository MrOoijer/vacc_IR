---
title: "Report_01"
author: "Jan van Rongen"
date: '2021-10-07'
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Introduction

We analyse data from the State of Israel related to COVID vaccines and infections. This is c continuation on the technical documents that contain all code used. They were a reanalysis of a document circulating on Internet, but this document focusses on proper modelling. 

The document itself is an RMarkdown worksheet that, when formatted in pdf, hides the code.

## Data sources and cleaning

As before We use four data sources: three from the Israeli government site and one from a spreadsheet with population data. The data was imported manually on 2021-10-02.

```{r echo= FALSE, message=FALSE, warning=FALSE}

source("get_clean.R") # get and clean data
source("./lib/lib.R") # plot routine
```

The file `vaccinated-per-day-2021-09-28` is aggregated to a per week file. Numeric fields with `<5` or `<15` were converted to 3 and 8 resp. Weeks are identified by their first day. Four missing records for the 90+ age category were added to `cases-among-vaccinated-134.csv`

Using the `population` table we construct cumulative totals of fulle vaccinated, single vaccinated and not vaccinated.

One file is not yet used.

## Goal and methods.

To analyse as best as possible two groups: fully vaccinated vs non vaccinated on rate of infection. Previous analysis (tech_doc_3) shows that a detailed breakdown in age groups does not help. Adults were vacinated immediately, under 20 much later. So we can restrict aourselves to these two groups. 

### Fully versus unvaccinated. 

Fully vaccinated in week x: those who received exactly two doses and their last dose in or before week x-2. It is highly unlikely that they were infected fwice while fully vaccinated so we assume that did not happen.

Unvaccinated: again here we assume that we measure the first infection.

Disease prior to start of 2020-12-20 vaccination: we assume that the population that already had at least one infection is $W=0.15$ of the total population. That should be a parameter that can be changed,


### State TRansition diagram

We draw a State Transition Diagram of all possible states a person could go through, one of the many possibilitie for such a diagram. We have to make choices because nmost possible diagrams have transitions that we cannot calculate. This one might work. . 

```{r message=FALSE, fig.width=7, fig.height=8, fig,cap= "STD"}
require(diagram)

states<- c("unvacc", "infected", "removed",
           "part vacc", "full vac", "boosted")
statemat<- matrix(0,6,6)
statemat[,1] <- c(0, 1, 0, 1, 0, 0)
statemat[, 2]<- c(0, 0, 1, 0, 0, 0)
statemat[, 4]<- c(0, 1, 0, 0, 1, 0)
statemat[, 5]<- c(0, 1, 0, 0, 0, 1)
statemat[, 6]<- c(0, 1, 0, 0, 0, 0)
colnames(statemat)<- rownames(statemat)<- states

plotmat(statemat, cex.txt=0, main="state transition diagram")


```

We do not know how many infected people are removed from the system, but in clinical trials in survival analysis people that reach an end state _are_  removed from the system. So we will do that. Of course this is an approximation we use as there is nothing better.


### Calculating Susceptible population. 

From this diagram we can derive how to calculate the susceptible populations for the unvacced and fully vacced groups. We know how to calculate them from the weekly vaccinations, but they have to loose their infected members at the proper moment in time. 

### Algorithm

The assumption is that the effectiveness of the vaccin decreases over time. From the SIR model we can learn that for unvaccinated population $S_n$, the amount of new incidents is a linear function of the effective $R_e(t)$. A vaccine with initial effectveness $\beta$ will have decaying effectiveness with a rate of $(\beta .e^{-\alpha.t})$ so the remaining effectiveness is one minus that. Taking the group of fully vaccinated people (wwithout booster)
we model the risk ratio $RR_{f/n} = 1-\beta .e^{-\alpha.t}$

This is in fact an exponential regression of $RR_{f/n}-1$ against the function $-\beta .e^{-\alpha.t}$. 

To get a truely least squares estimate (so that the errors heve zero sum) we use the R function `nls` from the base library and we estimate the confidence interval using the `invertR`package. 

## Get the data ready

We construct two data-frames for the Adults and the Youth Age groups with the relevant information. We assume that 15% of the population was infected before start vaccination. 

```{r}
LEFTOVER= 0.85

Adults<- data.frame(
  weekstart=fully_vac$weekstart, 
  full_cases= LEFTOVER*rowSums(fully_vac[, -(1:2)]) - 
    rowSums(triple_vac[, -(1:2)])
  )
Youth<- data.frame(
  weekstart=fully_vac$weekstart, 
  full_cases= LEFTOVER*fully_vac[,2] - 
    triple_vac[, 2]
)

# now shift the data 2 weeks ahead and start with 0's

Adults$full_cases<- c(0,0, Adults$full_cases[1:39])
Youth$full_cases<- c(0,0, Youth$full_cases[1:39])

#now the positive cases for Adults
tmp<- aggregate(. ~ weekstart, df1[df1$Age_group != "0-19", c(9,10,16)], sum)
Adults<- head(Adults,-1)
Adults$full_pos<- tmp[,2]+tmp[,3]
Adults$a<- Adults$full_pos
Adults$m1<- Adults$full_cases- c(0, cumsum(Adults$full_pos)[1:39])
# Risk rate f is a/m1

# and the non-vac cases for Adults
Adults$non_vac <- head(rowSums(not_vac[-(1:2)]), -1)
tmp<- aggregate(. ~ weekstart, df1[df1$Age_group != "0-19", c(15,16)], sum)
Adults$non_pos <- tmp[, 2] 
Adults$c<- Adults$non_pos
Adults$m2<- Adults$non_vac- c(0, cumsum(Adults$non_pos)[1:39])

## do Youth later
Adults$RR<- with(Adults,ifelse(m1==0, 0, (a/m1)/(c/m2)))
 
```


And now the estimates.

```{r fig.height=3, fig.width=5, fig.cap= "Adults RR"}
pretty_date(Adults[, c("weekstart", "RR")], ylim=0:1
      , main= "RR Adults\n fully vac after two weeks versus non vacc")


```

```{r warning= FALSE, message= FALSE, fig.height=3, fig.width=5, fig.cap= "Adults RR with exponential trend"}
regression_data<- data.frame(weekstart=Adults$weekstart, y=1-Adults$RR, nr=0:39)

l0<- lm(log(y) ~nr, regression_data)
beta0<- exp(l0$coeff[1])
alpha0<- l0$coeff[2]
l<- nls(y ~ beta* exp(alpha*nr), data=regression_data
        , start=list(alpha=alpha0, beta= beta0))

require(investr)
a <- predFit(l, newdate=regression_data$nr, interval = "confidence", level= 0.9)
a[,1]<- regression_data$weekstart


pretty_date(a, type="a", main="Non linear least squares regression for 1-RR\nPlus 95% CI", lwd=2, ylim=c(0,1.25)) 
pretty_date(regression_data, add=T)
df0<- regression_data
df0$y<- regression_data$y-residuals(l)
pretty_date(add=T, kleur=2 , df0, lty=2, lwd=2)



```

## Discussion

The adjustments on the input data are more realistic than previous attempts. The effect is that the RR decrease by the adjustments for positives, but increases when the proportion of positives in 2010 is increased. The overall piture howvere is smoother than without those adjustments,

From here we might conclude that the decay has a half-time of 6-10 months, but the data clearly does not fit the exponential model very well. In fact you woud never think of such a refression if you would only see the original curve.

As the above model is a Cox regression in disguise, we must conclude that any survival-like model does not model this data. 